# API ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ (API Versioning Guide)

## ğŸ“‹ ç›®å½•
1. [ä¸ºä»€ä¹ˆéœ€è¦ API ç‰ˆæœ¬æ§åˆ¶](#ä¸ºä»€ä¹ˆéœ€è¦-api-ç‰ˆæœ¬æ§åˆ¶)
2. [ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥](#ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥)
3. [é¡¹ç›®ä¸­çš„å®ç°æ–¹å¼](#é¡¹ç›®ä¸­çš„å®ç°æ–¹å¼)
4. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
5. [æœªæ¥æ‰©å±•](#æœªæ¥æ‰©å±•)

---

## ä¸ºä»€ä¹ˆéœ€è¦ API ç‰ˆæœ¬æ§åˆ¶

### 1. **å‘åå…¼å®¹æ€§ (Backward Compatibility)**
- **é—®é¢˜**ï¼šå½“ API éœ€è¦ä¿®æ”¹æ—¶ï¼ˆå¦‚æ”¹å˜å“åº”æ ¼å¼ã€åˆ é™¤å­—æ®µã€ä¿®æ”¹å‚æ•°ï¼‰ï¼Œç›´æ¥ä¿®æ”¹ä¼šå½±å“ç°æœ‰å®¢æˆ·ç«¯
- **è§£å†³**ï¼šé€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œæ—§ç‰ˆæœ¬ API ç»§ç»­å·¥ä½œï¼Œæ–°ç‰ˆæœ¬å¯ä»¥å¼•å…¥ç ´åæ€§å˜æ›´

### 2. **æ¸è¿›å¼æ¼”è¿› (Gradual Evolution)**
- å…è®¸ API é€æ­¥æ”¹è¿›ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§é‡å†™æ‰€æœ‰æ¥å£
- å®¢æˆ·ç«¯å¯ä»¥æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥è¿ç§»åˆ°æ–°ç‰ˆæœ¬

### 3. **å¤šå®¢æˆ·ç«¯æ”¯æŒ (Multiple Client Support)**
- ä¸åŒå®¢æˆ·ç«¯å¯èƒ½ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ API
- ç§»åŠ¨åº”ç”¨ã€Web åº”ç”¨ã€ç¬¬ä¸‰æ–¹é›†æˆå¯ä»¥åŒæ—¶ä½¿ç”¨ä¸åŒç‰ˆæœ¬

### 4. **é™ä½é£é™© (Risk Mitigation)**
- æ–°ç‰ˆæœ¬å¯ä»¥å…ˆå‘å¸ƒç»™éƒ¨åˆ†ç”¨æˆ·æµ‹è¯•
- å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å›é€€æˆ–ä¿®å¤ï¼Œä¸å½±å“æ—§ç‰ˆæœ¬ç”¨æˆ·

---

## ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥

### å¸¸è§çš„ç‰ˆæœ¬æ§åˆ¶æ–¹å¼

#### 1. **URL è·¯å¾„ç‰ˆæœ¬æ§åˆ¶ (URL Path Versioning)** â­ æœ¬é¡¹ç›®ä½¿ç”¨
```
/api/v1/users
/api/v2/users
```
- âœ… **ä¼˜ç‚¹**ï¼šæ¸…æ™°ã€ç›´è§‚ã€æ˜“äºç†è§£
- âœ… **ä¼˜ç‚¹**ï¼šRESTful é£æ ¼ï¼Œç¬¦åˆ HTTP æ ‡å‡†
- âœ… **ä¼˜ç‚¹**ï¼šæ˜“äºåœ¨åå‘ä»£ç†ä¸­è·¯ç”±
- âŒ **ç¼ºç‚¹**ï¼šURL å˜é•¿

#### 2. **æŸ¥è¯¢å‚æ•°ç‰ˆæœ¬æ§åˆ¶ (Query Parameter Versioning)**
```
/api/users?version=1
/api/users?v=2
```
- âœ… **ä¼˜ç‚¹**ï¼šURL ç®€æ´
- âŒ **ç¼ºç‚¹**ï¼šä¸å¤Ÿ RESTful
- âŒ **ç¼ºç‚¹**ï¼šç¼“å­˜å¯èƒ½æœ‰é—®é¢˜

#### 3. **HTTP å¤´ç‰ˆæœ¬æ§åˆ¶ (Header Versioning)**
```
GET /api/users
Accept: application/vnd.api.v1+json
```
- âœ… **ä¼˜ç‚¹**ï¼šURL ä¸å˜
- âŒ **ç¼ºç‚¹**ï¼šä¸å¤Ÿç›´è§‚ï¼Œéœ€è¦æŸ¥çœ‹æ–‡æ¡£
- âŒ **ç¼ºç‚¹**ï¼šæµè§ˆå™¨æµ‹è¯•ä¸æ–¹ä¾¿

#### 4. **å­åŸŸåç‰ˆæœ¬æ§åˆ¶ (Subdomain Versioning)**
```
https://v1.api.example.com/users
https://v2.api.example.com/users
```
- âœ… **ä¼˜ç‚¹**ï¼šå®Œå…¨éš”ç¦»
- âŒ **ç¼ºç‚¹**ï¼šéœ€è¦ DNS é…ç½®
- âŒ **ç¼ºç‚¹**ï¼šSSL è¯ä¹¦ç®¡ç†å¤æ‚

---

## é¡¹ç›®ä¸­çš„å®ç°æ–¹å¼

### å½“å‰é¡¹ç›®ç»“æ„

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ v1/                    # API ç‰ˆæœ¬ 1
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ health.py          # å¥åº·æ£€æŸ¥ç«¯ç‚¹
â”‚       â”œâ”€â”€ auth.py            # è®¤è¯ç«¯ç‚¹
â”‚       â”œâ”€â”€ tasks.py           # ä»»åŠ¡ç«¯ç‚¹
â”‚       â””â”€â”€ users.py           # ç”¨æˆ·ç«¯ç‚¹
```

### ä»£ç å®ç°

#### 1. **Connexion é…ç½®** (`app/connexion_app.py`)

```python
# ä½¿ç”¨ RelativeResolver æŒ‡å‘ v1 æ¨¡å—
resolver = connexion.resolver.RelativeResolver("app.api.v1")

# æ³¨å†Œ APIï¼Œbase_path ä¸º /api
api = connexion_app.add_api(
    "openapi.yaml",
    base_path="/api",           # æ‰€æœ‰è·¯å¾„å‰ç¼€ä¸º /api
    resolver=resolver           # è§£æå™¨æŒ‡å‘ v1
)
```

#### 2. **OpenAPI è§„èŒƒ** (`openapi/openapi.yaml`)

```yaml
paths:
  /ping:                        # å®é™…è·¯å¾„: /api/ping
    get:
      operationId: health.ping  # æ˜ å°„åˆ° app.api.v1.health.ping
      
  /auth/login:                 # å®é™…è·¯å¾„: /api/auth/login
    post:
      operationId: auth.login   # æ˜ å°„åˆ° app.api.v1.auth.login
```

#### 3. **ç«¯ç‚¹å®ç°** (`app/api/v1/health.py`)

```python
def ping():
    """Return a simple health payload."""
    return {"ok": True}
```

### è·¯å¾„æ˜ å°„å…³ç³»

| OpenAPI è·¯å¾„ | operationId | Python å‡½æ•° | å®é™… URL |
|-------------|-------------|-------------|----------|
| `/ping` | `health.ping` | `app.api.v1.health.ping` | `/api/ping` |
| `/auth/login` | `auth.login` | `app.api.v1.auth.login` | `/api/auth/login` |
| `/users` | `users.list_users` | `app.api.v1.users.list_users` | `/api/users` |

---

## æœ€ä½³å®è·µ

### 1. **ä½•æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Ÿ**

#### âœ… **åº”è¯¥åˆ›å»ºæ–°ç‰ˆæœ¬çš„æƒ…å†µï¼š**
- **ç ´åæ€§å˜æ›´**ï¼šåˆ é™¤å¿…éœ€å­—æ®µã€æ”¹å˜å­—æ®µç±»å‹ã€æ”¹å˜å“åº”ç»“æ„
- **é‡å¤§åŠŸèƒ½å˜æ›´**ï¼šå®Œå…¨é‡å†™æŸä¸ªç«¯ç‚¹
- **å®‰å…¨ç­–ç•¥å˜æ›´**ï¼šæ”¹å˜è®¤è¯æ–¹å¼ã€æƒé™æ¨¡å‹

#### âŒ **ä¸éœ€è¦æ–°ç‰ˆæœ¬çš„æƒ…å†µï¼š**
- **æ·»åŠ æ–°å­—æ®µ**ï¼šå‘åå…¼å®¹ï¼Œæ—§å®¢æˆ·ç«¯å¿½ç•¥æ–°å­—æ®µ
- **æ·»åŠ æ–°ç«¯ç‚¹**ï¼šä¸å½±å“ç°æœ‰ç«¯ç‚¹
- **Bug ä¿®å¤**ï¼šä¿®å¤ç°æœ‰è¡Œä¸ºï¼Œä¸æ”¹å˜æ¥å£å¥‘çº¦
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå†…éƒ¨å®ç°æ”¹å˜ï¼Œæ¥å£ä¸å˜

### 2. **ç‰ˆæœ¬å‘½åè§„èŒƒ**

```
v1, v2, v3...          # ä¸»è¦ç‰ˆæœ¬ï¼ˆç ´åæ€§å˜æ›´ï¼‰
v1.1, v1.2...          # æ¬¡è¦ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œç”¨äºå°èŒƒå›´å˜æ›´ï¼‰
```

### 3. **ç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```
v1 (ç¨³å®š) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚
v2 (å½“å‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€ åŒæ—¶æ”¯æŒå¤šä¸ªç‰ˆæœ¬
                         â”‚
v3 (å¼€å‘ä¸­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **å¼ƒç”¨ç­–ç•¥ (Deprecation Policy)**

```http
GET /api/v1/users
X-API-Deprecation: true
X-API-Sunset: 2025-12-31
X-API-Successor: /api/v2/users
```

### 5. **æ–‡æ¡£å’Œè¿ç§»æŒ‡å—**

- ä¸ºæ¯ä¸ªç‰ˆæœ¬ç»´æŠ¤ç‹¬ç«‹çš„æ–‡æ¡£
- æä¾›ä» v1 åˆ° v2 çš„è¿ç§»æŒ‡å—
- è¯´æ˜å˜æ›´åŸå› å’Œå½±å“

---

## æœªæ¥æ‰©å±•

### æ·»åŠ  v2 ç‰ˆæœ¬çš„æ­¥éª¤

#### 1. **åˆ›å»º v2 ç›®å½•ç»“æ„**

```
app/
â””â”€â”€ api/
    â”œâ”€â”€ v1/              # ä¿æŒç°æœ‰ç‰ˆæœ¬
    â”‚   â”œâ”€â”€ health.py
    â”‚   â””â”€â”€ ...
    â””â”€â”€ v2/              # æ–°ç‰ˆæœ¬
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ health.py
        â””â”€â”€ ...
```

#### 2. **åˆ›å»º v2 çš„ OpenAPI è§„èŒƒ**

```yaml
# openapi/v2/openapi.yaml
openapi: 3.0.3
info:
  version: 2.0.0
paths:
  /ping:
    get:
      operationId: health.ping
```

#### 3. **æ³¨å†Œ v2 API**

```python
# app/connexion_app.py

# v1 API (ä¿æŒä¸å˜)
resolver_v1 = connexion.resolver.RelativeResolver("app.api.v1")
connexion_app.add_api(
    "openapi.yaml",
    base_path="/api/v1",
    resolver=resolver_v1
)

# v2 API (æ–°ç‰ˆæœ¬)
resolver_v2 = connexion.resolver.RelativeResolver("app.api.v2")
connexion_app.add_api(
    "openapi/v2/openapi.yaml",
    base_path="/api/v2",
    resolver=resolver_v2
)
```

#### 4. **URL å¯¹æ¯”**

| ç‰ˆæœ¬ | æ—§ URL | æ–° URL |
|------|--------|--------|
| v1 | `/api/ping` | `/api/v1/ping` |
| v2 | - | `/api/v2/ping` |

---

## å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå­—æ®µå˜æ›´

**v1 å“åº”ï¼š**
```json
{
  "id": 1,
  "name": "John",
  "email": "john@example.com"
}
```

**v2 å“åº”ï¼ˆæ·»åŠ äº†å­—æ®µï¼‰ï¼š**
```json
{
  "id": 1,
  "name": "John",
  "email": "john@example.com",
  "avatar": "https://...",      // æ–°å­—æ®µ
  "created_at": "2024-01-01"     // æ–°å­—æ®µ
}
```
âœ… **å‘åå…¼å®¹**ï¼šv1 å®¢æˆ·ç«¯å¯ä»¥å¿½ç•¥æ–°å­—æ®µ

### æ¡ˆä¾‹ 2ï¼šç ´åæ€§å˜æ›´

**v1 å“åº”ï¼š**
```json
{
  "user": {
    "id": 1,
    "name": "John"
  }
}
```

**v2 å“åº”ï¼ˆç»“æ„æ”¹å˜ï¼‰ï¼š**
```json
{
  "data": {
    "id": 1,
    "name": "John",
    "profile": {...}
  }
}
```
âŒ **ä¸å…¼å®¹**ï¼šéœ€è¦åˆ›å»º v2

---

## æ€»ç»“

### æ ¸å¿ƒåŸåˆ™
1. **å‘åå…¼å®¹ä¼˜å…ˆ**ï¼šå°½é‡åœ¨ä¸ç ´åç°æœ‰å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹æ¼”è¿›
2. **æ˜ç¡®ç‰ˆæœ¬ç­–ç•¥**ï¼šåˆ¶å®šæ¸…æ™°çš„ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
3. **å……åˆ†æ²Ÿé€š**ï¼šæå‰é€šçŸ¥å®¢æˆ·ç«¯ç‰ˆæœ¬å˜æ›´
4. **å¹³æ»‘è¿ç§»**ï¼šæä¾›è¿ç§»å·¥å…·å’Œæ–‡æ¡£

### é¡¹ç›®å½“å‰çŠ¶æ€
- âœ… ä½¿ç”¨ URL è·¯å¾„ç‰ˆæœ¬æ§åˆ¶
- âœ… æ¨¡å—åŒ–ç»„ç»‡ï¼ˆv1 æ–‡ä»¶å¤¹ï¼‰
- âœ… ä½¿ç”¨ Connexion + OpenAPI è§„èŒƒ
- âœ… æ¸…æ™°çš„ä»£ç ç»“æ„

### å»ºè®®
- å½“å‰æ‰€æœ‰ç«¯ç‚¹éƒ½åœ¨ `/api/*`ï¼Œè¿™æ˜¯ v1 çš„éšå¼ç‰ˆæœ¬
- æœªæ¥å¦‚æœéœ€è¦ v2ï¼Œå¯ä»¥æ”¹ä¸º `/api/v1/*` å’Œ `/api/v2/*`
- æˆ–è€…ä¿æŒå½“å‰ç»“æ„ï¼Œåªåœ¨éœ€è¦æ—¶æ·»åŠ  `/api/v2/*`

---

## å‚è€ƒèµ„æº

- [REST API Versioning Best Practices](https://restfulapi.net/versioning/)
- [API Versioning Strategies](https://www.baeldung.com/rest-versioning)
- [Connexion Documentation](https://connexion.readthedocs.io/)
- [OpenAPI Specification](https://swagger.io/specification/)

